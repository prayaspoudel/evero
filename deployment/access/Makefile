# Access Module Deployment Makefile
# This Makefile handles deployment operations for the access module

.PHONY: help setup build deploy clean logs migrate migrate-down health docker-build docker-up docker-down

MODULE := access
BINARY := bin/access
CONFIG_DIR := config/access
DEPLOYMENT_DIR := deployment/access

help: ## Display this help screen
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

setup: ## Complete setup for access module
	@echo "ğŸš€ Setting up Access module..."
	@./setup.sh
	@echo "âœ… Access module setup complete"

build: ## Build the access module
	@echo "ğŸ”¨ Building Access module..."
	@cd ../.. && go build -o $(BINARY) ./modules/access/cmd/server
	@echo "âœ… Build complete: $(BINARY)"

run: ## Run the access module locally
	@echo "â–¶ï¸  Running Access module..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/local.json

run-dev: ## Run in development mode
	@echo "â–¶ï¸  Running Access module (development)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/development.json

run-stage: ## Run in staging mode
	@echo "â–¶ï¸  Running Access module (staging)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/stage.json

run-prod: ## Run in production mode
	@echo "â–¶ï¸  Running Access module (production)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/production.json

migrate: ## Run database migrations
	@echo "ğŸ“¦ Running Access module migrations..."
	@cd ../.. && go run ./infrastructure/database/migrate.go --module=access --direction=up
	@echo "âœ… Migrations complete"

migrate-down: ## Rollback database migrations
	@echo "âª Rolling back Access module migrations..."
	@cd ../.. && go run ./infrastructure/database/migrate.go --module=access --direction=down
	@echo "âœ… Rollback complete"

test: ## Run tests
	@echo "ğŸ§ª Running Access module tests..."
	@cd ../.. && go test -v ./modules/access/...
	@echo "âœ… Tests complete"

test-coverage: ## Run tests with coverage
	@echo "ğŸ§ª Running Access module tests with coverage..."
	@cd ../.. && go test -v -coverprofile=coverage-access.out ./modules/access/...
	@cd ../.. && go tool cover -html=coverage-access.out
	@echo "âœ… Coverage report generated"

docker-build: ## Build Docker image
	@echo "ğŸ³ Building Access module Docker image..."
	@docker build -f Dockerfile -t evero-access:latest ../..
	@echo "âœ… Docker image built"

docker-up: ## Start Docker containers
	@echo "ğŸ³ Starting Access module containers..."
	@docker-compose up -d
	@echo "âœ… Containers started"

docker-down: ## Stop Docker containers
	@echo "ğŸ³ Stopping Access module containers..."
	@docker-compose down
	@echo "âœ… Containers stopped"

docker-logs: ## View Docker logs
	@docker-compose logs -f access

deploy: build migrate ## Deploy the access module (build + migrate)
	@echo "ğŸš€ Deploying Access module..."
	@echo "âœ… Deployment complete"

clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning Access module artifacts..."
	@cd ../.. && rm -rf $(BINARY)
	@cd ../.. && rm -f coverage-access.out
	@echo "âœ… Clean complete"

health: ## Check module health
	@echo "ğŸ¥ Checking Access module health..."
	@curl -f http://localhost:3000/health || echo "âŒ Health check failed"

logs: ## View application logs
	@echo "ğŸ“‹ Viewing Access module logs..."
	@tail -f ../../logs/access.log

.DEFAULT_GOAL := help
