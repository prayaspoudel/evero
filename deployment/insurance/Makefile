# Insurance Module Deployment Makefile
# This Makefile handles deployment operations for the insurance module

.PHONY: help setup build deploy clean logs migrate migrate-down health docker-build docker-up docker-down

MODULE := insurance
BINARY := bin/insurance
CONFIG_DIR := config/insurance
DEPLOYMENT_DIR := deployment/insurance

help: ## Display this help screen
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

setup: ## Complete setup for insurance module
	@echo "ğŸ›¡ï¸  Setting up Insurance module..."
	@./setup.sh
	@echo "âœ… Insurance module setup complete"

build: ## Build the insurance module
	@echo "ğŸ”¨ Building Insurance module..."
	@cd ../.. && go build -o $(BINARY) ./app/insurance
	@echo "âœ… Build complete: $(BINARY)"

run: ## Run the insurance module locally
	@echo "â–¶ï¸  Running Insurance module..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/local.json

run-dev: ## Run in development mode
	@echo "â–¶ï¸  Running Insurance module (development)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/development.json

run-stage: ## Run in staging mode
	@echo "â–¶ï¸  Running Insurance module (staging)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/stage.json

run-prod: ## Run in production mode
	@echo "â–¶ï¸  Running Insurance module (production)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/production.json

migrate: ## Run database migrations
	@echo "ğŸ“¦ Running Insurance module migrations..."
	@cd ../.. && go run ./infrastructure/database/migrate.go --module=insurance --direction=up
	@echo "âœ… Migrations complete"

migrate-down: ## Rollback database migrations
	@echo "âª Rolling back Insurance module migrations..."
	@cd ../.. && go run ./infrastructure/database/migrate.go --module=insurance --direction=down
	@echo "âœ… Rollback complete"

test: ## Run tests
	@echo "ğŸ§ª Running Insurance module tests..."
	@cd ../.. && go test -v ./app/insurance/...
	@echo "âœ… Tests complete"

test-coverage: ## Run tests with coverage
	@echo "ğŸ§ª Running Insurance module tests with coverage..."
	@cd ../.. && go test -v -coverprofile=coverage-insurance.out ./app/insurance/...
	@cd ../.. && go tool cover -html=coverage-insurance.out
	@echo "âœ… Coverage report generated"

docker-build: ## Build Docker image
	@echo "ğŸ³ Building Insurance module Docker image..."
	@docker build -f Dockerfile -t evero-insurance:latest ../..
	@echo "âœ… Docker image built"

docker-up: ## Start Docker containers
	@echo "ğŸ³ Starting Insurance module containers..."
	@docker-compose up -d
	@echo "âœ… Containers started"

docker-down: ## Stop Docker containers
	@echo "ğŸ³ Stopping Insurance module containers..."
	@docker-compose down
	@echo "âœ… Containers stopped"

docker-logs: ## View Docker logs
	@docker-compose logs -f insurance

deploy: build migrate ## Deploy the insurance module (build + migrate)
	@echo "ğŸš€ Deploying Insurance module..."
	@echo "âœ… Deployment complete"

clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning Insurance module artifacts..."
	@cd ../.. && rm -rf $(BINARY)
	@cd ../.. && rm -f coverage-insurance.out
	@echo "âœ… Clean complete"

health: ## Check module health
	@echo "ğŸ›¡ï¸  Checking Insurance module health..."
	@curl -f http://localhost:3002/health || echo "âŒ Health check failed"

logs: ## View application logs
	@echo "ğŸ“‹ Viewing Insurance module logs..."
	@tail -f ../../logs/insurance.log

.DEFAULT_GOAL := help
