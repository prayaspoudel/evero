# Finance Module Deployment Makefile
# This Makefile handles deployment operations for the finance module

.PHONY: help setup build deploy clean logs migrate migrate-down health docker-build docker-up docker-down

MODULE := finance
BINARY := bin/finance
CONFIG_DIR := config/finance
DEPLOYMENT_DIR := deployment/finance

help: ## Display this help screen
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

setup: ## Complete setup for finance module
	@echo "ğŸ’° Setting up Finance module..."
	@./setup.sh
	@echo "âœ… Finance module setup complete"

build: ## Build the finance module
	@echo "ğŸ”¨ Building Finance module..."
	@cd ../.. && go build -o $(BINARY) ./app/finance
	@echo "âœ… Build complete: $(BINARY)"

run: ## Run the finance module locally
	@echo "â–¶ï¸  Running Finance module..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/local.json

run-dev: ## Run in development mode
	@echo "â–¶ï¸  Running Finance module (development)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/development.json

run-stage: ## Run in staging mode
	@echo "â–¶ï¸  Running Finance module (staging)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/stage.json

run-prod: ## Run in production mode
	@echo "â–¶ï¸  Running Finance module (production)..."
	@cd ../.. && ./$(BINARY) --config=$(CONFIG_DIR)/production.json

migrate: ## Run database migrations
	@echo "ğŸ“¦ Running Finance module migrations..."
	@cd ../.. && go run ./infrastructure/database/migrate.go --module=finance --direction=up
	@echo "âœ… Migrations complete"

migrate-down: ## Rollback database migrations
	@echo "âª Rolling back Finance module migrations..."
	@cd ../.. && go run ./infrastructure/database/migrate.go --module=finance --direction=down
	@echo "âœ… Rollback complete"

test: ## Run tests
	@echo "ğŸ§ª Running Finance module tests..."
	@cd ../.. && go test -v ./app/finance/...
	@echo "âœ… Tests complete"

test-coverage: ## Run tests with coverage
	@echo "ğŸ§ª Running Finance module tests with coverage..."
	@cd ../.. && go test -v -coverprofile=coverage-finance.out ./app/finance/...
	@cd ../.. && go tool cover -html=coverage-finance.out
	@echo "âœ… Coverage report generated"

docker-build: ## Build Docker image
	@echo "ğŸ³ Building Finance module Docker image..."
	@docker build -f Dockerfile -t evero-finance:latest ../..
	@echo "âœ… Docker image built"

docker-up: ## Start Docker containers
	@echo "ğŸ³ Starting Finance module containers..."
	@docker-compose up -d
	@echo "âœ… Containers started"

docker-down: ## Stop Docker containers
	@echo "ğŸ³ Stopping Finance module containers..."
	@docker-compose down
	@echo "âœ… Containers stopped"

docker-logs: ## View Docker logs
	@docker-compose logs -f finance

deploy: build migrate ## Deploy the finance module (build + migrate)
	@echo "ğŸš€ Deploying Finance module..."
	@echo "âœ… Deployment complete"

clean: ## Clean build artifacts
	@echo "ğŸ§¹ Cleaning Finance module artifacts..."
	@cd ../.. && rm -rf $(BINARY)
	@cd ../.. && rm -f coverage-finance.out
	@echo "âœ… Clean complete"

health: ## Check module health
	@echo "ğŸ’° Checking Finance module health..."
	@curl -f http://localhost:3003/health || echo "âŒ Health check failed"

logs: ## View application logs
	@echo "ğŸ“‹ Viewing Finance module logs..."
	@tail -f ../../logs/finance.log

.DEFAULT_GOAL := help
